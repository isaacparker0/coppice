name: CI

on:
    pull_request:
    push:
        branches:
            - main

permissions:
    contents: read

concurrency:
    group: ci-${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    ci:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6

            - name: Cache Bazel repository downloads
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/bazel-repo
                  key: coppice-bazel-repo-${{ runner.os }}-${{ hashFiles('MODULE.bazel.lock') }}
                  restore-keys: |
                      coppice-bazel-repo-${{ runner.os }}-

            - name: Run checks, build, and tests
              env:
                  BUILDBUDDY_API_KEY: ${{ secrets.BUILDBUDDY_API_KEY }}
              run: |
                  set -euo pipefail
                  bazel mod deps --config=remote --lockfile_mode=error
                  bazel run --config=remote //:gazelle -- -mode=diff
                  bazel run --config=remote //:format -- check
                  bazel build --config=remote //...
                  bazel test --config=remote //...
                  bazel run --config=remote --run_in_cwd @multitool//tools/typos
                  bazel run --config=remote //tools/filename_linter:main
