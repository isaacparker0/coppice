actions:
    - name: CI
      container_image: "ubuntu-24.04"
      triggers:
          push:
              branches:
                  - main
          pull_request:
              branches:
                  - "*"
      steps:
          - run: bazel mod deps --lockfile_mode=error
          - run: bazel run //:gazelle -- -mode=diff
          - run: bazel run //:format -- check
          - run: bazel build //...
          - run: bazel test //...
          - run: bazel run --run_in_cwd @multitool//tools/typos
          - run: bazel run //tools/filename_linter:main
          # Authenticate to DOCR for rules_oci
          - run: |
                set -euo pipefail
                # if [[ "${GIT_PR_NUMBER:-0}" -gt 0 ]]; then
                #   exit 0
                # fi
                : "${DOCR_TOKEN:?DOCR_TOKEN must be set}"
                export DOCKER_CONFIG="${HOME}/.docker"
                mkdir -p "${DOCKER_CONFIG}"
                AUTH="$(printf "doctl:%s" "$DOCR_TOKEN" | base64 -w 0 2>/dev/null || printf "doctl:%s" "$DOCR_TOKEN" | base64)"
                printf '{"auths":{"registry.digitalocean.com":{"auth":"%s"}}}\n' "$AUTH" > "${DOCKER_CONFIG}/config.json"
          - run: |
                set -euo pipefail
                # if [[ "${GIT_PR_NUMBER:-0}" -gt 0 ]]; then
                #   exit 0
                # fi
                export DOCKER_CONFIG="${HOME}/.docker"
                bazel run --stamp --platforms=@toolchains_llvm_bootstrapped//platforms:linux_amd64 //playground:playground_push
